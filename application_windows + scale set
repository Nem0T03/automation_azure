#!/bin/bash

# Variables
resourceGroup="AZ900-RG"
location="EastAsia"
mainVMName="MainVM"
vmssName="ScaleSetVM"
storageAccountName="mystorageaccount$RANDOM"
containerNameMain="main-container"
containerNameScaleSet="scaleset-container"
adminUsername="azureuser"
vmSize="Standard_DS1_v2"
image="Win2019Datacenter"
scriptFileName="install_iis.ps1"
indexHtmlFileName="index.html"
adminPassword="YourPassword@123"  # Replace with your secure password
expiryDate="2024-12-31T23:59:00Z"  # Adjust expiry date for SAS token as needed
nsgName="MyNSG"
vnetName="MyVNet"
subnetName="MySubnet"
scaleSetCapacity=1
minInstanceCount=1
maxInstanceCount=5

# Step 1: Create the resource group
echo "Creating Resource Group: $resourceGroup..."
az group create --name "$resourceGroup" --location "$location"

# Step 2: Create a virtual network and subnet
echo "Creating Virtual Network: $vnetName..."
az network vnet create --resource-group "$resourceGroup" --name "$vnetName" --subnet-name "$subnetName" --location "$location"

# Step 3: Create a Network Security Group (NSG)
echo "Creating Network Security Group: $nsgName..."
az network nsg create --resource-group "$resourceGroup" --name "$nsgName" --location "$location"

# Step 4: Create inbound security rules to allow HTTP (port 80) in NSG
echo "Creating inbound security rule for port 80 (HTTP)..."
az network nsg rule create \
  --resource-group "$resourceGroup" \
  --nsg-name "$nsgName" \
  --name "AllowHTTP" \
  --priority 1001 \
  --protocol Tcp \
  --destination-port-ranges 80 \
  --access Allow \
  --direction Inbound

# Step 5: Associate the NSG with the subnet
echo "Associating NSG with the subnet..."
az network vnet subnet update --vnet-name "$vnetName" --name "$subnetName" --resource-group "$resourceGroup" --network-security-group "$nsgName"

# Step 6: Create a storage account
echo "Creating Storage Account: $storageAccountName..."
az storage account create --name "$storageAccountName" --resource-group "$resourceGroup" --location "$location" --sku Standard_LRS

# Step 7: Retrieve the storage account key
echo "Retrieving Storage Account Key..."
accountKey=$(az storage account keys list --resource-group "$resourceGroup" --account-name "$storageAccountName" --query '[0].value' -o tsv)

# Step 8: Create containers in the storage account
echo "Creating containers..."
az storage container create --name "$containerNameMain" --account-name "$storageAccountName" --account-key "$accountKey"
az storage container create --name "$containerNameScaleSet" --account-name "$storageAccountName" --account-key "$accountKey"

# Step 9: Create the index.html file template
echo "Creating index.html file template..."
cat <<EOF > "$indexHtmlFileName"
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to My Web Server</title>
</head>
<body>
    <h1>Hello, World!</h1>
    <p>This is a simple web page hosted on my Windows Server.</p>
    <p>Main VM Public IP: <strong>%PUBLIC_IP%</strong></p>
</body>
</html>
EOF

# Step 10: Upload the script to the appropriate containers
echo "Uploading script to containers..."
echo 'Install-WindowsFeature -name Web-Server -IncludeManagementTools' > "$scriptFileName"
az storage blob upload --account-name "$storageAccountName" --account-key "$accountKey" --container-name "$containerNameMain" --file "$scriptFileName" --name "$scriptFileName"
az storage blob upload --account-name "$storageAccountName" --account-key "$accountKey" --container-name "$containerNameScaleSet" --file "$scriptFileName" --name "$scriptFileName"

# Step 11: Generate SAS tokens for the script
echo "Generating SAS tokens for the script..."
sasTokenMain=$(az storage blob generate-sas --account-name "$storageAccountName" --container-name "$containerNameMain" --name "$scriptFileName" --permissions r --expiry "$expiryDate" --account-key "$accountKey" --https-only --output tsv)
sasTokenScaleSet=$(az storage blob generate-sas --account-name "$storageAccountName" --container-name "$containerNameScaleSet" --name "$scriptFileName" --permissions r --expiry "$expiryDate" --account-key "$accountKey" --https-only --output tsv)

# Construct the full URL to the script with the SAS tokens
scriptFileUriMain="https://$storageAccountName.blob.core.windows.net/$containerNameMain/$scriptFileName?$sasTokenMain"
scriptFileUriScaleSet="https://$storageAccountName.blob.core.windows.net/$containerNameScaleSet/$scriptFileName?$sasTokenScaleSet"

# Step 12: Create the main VM
echo "Creating main VM: $mainVMName..."
az vm create \
  --resource-group "$resourceGroup" \
  --name "$mainVMName" \
  --image "$image" \
  --admin-username "$adminUsername" \
  --admin-password "$adminPassword" \
  --size "$vmSize" \
  --public-ip-sku Standard \
  --vnet-name "$vnetName" \
  --subnet "$subnetName"

# Step 13: Retrieve the public IP of the main VM
echo "Retrieving the public IP of the main VM..."
publicIP=$(az vm show --resource-group "$resourceGroup" --name "$mainVMName" --query "publicIpAddress" -o tsv)

# Step 14: Replace placeholder in index.html with the public IP
echo "Updating index.html with public IP..."
sed -i "s/%PUBLIC_IP%/$publicIP/g" "$indexHtmlFileName"

# Step 15: Upload the updated index.html file to the main VM container
echo "Uploading updated index.html to the main container..."
az storage blob upload --account-name "$storageAccountName" --account-key "$accountKey" --container-name "$containerNameMain" --file "$indexHtmlFileName" --name "$indexHtmlFileName"

# Step 16: Create the VM Scale Set
echo "Creating VM Scale Set: $vmssName..."
az vmss create \
  --resource-group "$resourceGroup" \
  --name "$vmssName" \
  --image "$image" \
  --admin-username "$adminUsername" \
  --instance-count $scaleSetCapacity \
  --vm-sku "$vmSize" \
  --subnet "$subnetName" \
  --vnet-name "$vnetName" \
  --upgrade-policy-mode automatic \
  --storage-sku Standard_LRS \
  --authentication-type password \
  --admin-password "$adminPassword"

# Step 17: Add Custom Script Extension to install IIS from the script
echo "Adding Custom Script Extension to VM Scale Set..."
az vmss extension set \
  --publisher Microsoft.Compute \
  --version 1.10 \
  --name CustomScriptExtension \
  --resource-group "$resourceGroup" \
  --vmss-name "$vmssName" \
  --settings "{'fileUris': ['$scriptFileUriScaleSet'], 'commandToExecute': 'powershell -ExecutionPolicy Unrestricted -File $scriptFileName'}"

# Step 18: Configure Autoscaling for the VM Scale Set
echo "Configuring autoscale for VM Scale Set..."
az monitor autoscale create \
  --resource-group "$resourceGroup" \
  --name "$vmssName-autoscale" \
  --target "$vmssName" \
  --min-count $minInstanceCount \
  --max-count $maxInstanceCount \
  --count $scaleSetCapacity

# Step 19: Define autoscale rule to scale out based on CPU usage
echo "Adding scale-out rule based on CPU usage..."
az monitor autoscale rule create \
  --resource-group "$resourceGroup" \
  --autoscale-name "$vmssName-autoscale" \
  --condition "Percentage CPU > 1 avg 1m" \
  --scale out 1 \
  --cooldown 1

# Step 20: Output the public IP of the main VM
echo "Deployment complete!"
echo "Main VM Public IP: $publicIP"
echo "You can access your web server at http://$publicIP/index.html"
